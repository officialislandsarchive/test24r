<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Day Beter LEDs</title>
</head>
<body>
  <h1>Control Day Beter LEDs</h1>
  <button id="connectBtn">Connect to P031_CFC7</button>
  <button id="turnOnBtn" disabled>Turn On</button>
  <button id="turnOffBtn" disabled>Turn Off</button>

  <div id="status"></div> <!-- This will display status updates -->
  <div id="deviceInfo">
    <p><strong>Wi-Fi Status:</strong> <span id="wifiStatus">Checking...</span></p>
    <p><strong>Bluetooth Status:</strong> <span id="bluetoothStatus">Checking...</span></p>
  </div> <!-- Additional device information -->

  <script>
    let device;
    let server;
    let lightService;
    let lightCharacteristic;

    // Replace these with the actual UUIDs you found in the nRF Connect app
    const serviceUUID = '0000aaa0-0000-1000-8000-aabbccddeeff'; // Example: '00001800-0000-1000-8000-00805f9b34fb'
    const characteristicUUID = '0000aaa2-0000-1000-8000-aabbccddeeff'; // Example: '00002a00-0000-1000-8000-00805f9b34fb'

    // Function to update status text
    function updateStatus(message) {
      document.getElementById("status").innerText = message;
    }

    // Function to check if Wi-Fi is connected (basic check using navigator.connection)
    function checkWifiStatus() {
      if (navigator.connection && navigator.connection.type) {
        const wifiStatus = navigator.connection.type === "wifi" ? "Connected" : "Not connected to Wi-Fi";
        document.getElementById("wifiStatus").innerText = wifiStatus;
      } else {
        document.getElementById("wifiStatus").innerText = "Unable to determine Wi-Fi status";
      }
    }

    // Function to check Bluetooth availability
    function checkBluetoothStatus() {
      if (navigator.bluetooth) {
        document.getElementById("bluetoothStatus").innerText = "Bluetooth is supported and available.";
      } else {
        document.getElementById("bluetoothStatus").innerText = "Bluetooth is not supported or unavailable on this device.";
      }
    }

    // Call functions on page load to check Wi-Fi and Bluetooth
    window.onload = () => {
      checkWifiStatus();
      checkBluetoothStatus();
    };

    // Connect to Bluetooth device
    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        updateStatus("Connecting to P031_CFC7...");

        // Request the Bluetooth device
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'P031_CFC7' }],
          optionalServices: [serviceUUID] // Replace with your service UUID
        });

        updateStatus(`Device found: ${device.name}`);

        // Connect to the device's GATT server
        server = await device.gatt.connect();
        updateStatus(`Connected to GATT server of ${device.name}`);

        // Get the light service
        try {
          lightService = await server.getPrimaryService(serviceUUID);
          updateStatus(`Service found: ${serviceUUID}`);
        } catch (serviceError) {
          console.error('Error getting light service', serviceError);
          updateStatus(`Failed to find service with UUID: ${serviceUUID}`);
          return;
        }

        // Get the characteristic to control the light
        try {
          lightCharacteristic = await lightService.getCharacteristic(characteristicUUID);
          updateStatus(`Characteristic found: ${characteristicUUID}`);
        } catch (charError) {
          console.error('Error getting characteristic', charError);
          updateStatus(`Failed to find characteristic with UUID: ${characteristicUUID}`);
          return;
        }

        // Enable the control buttons once connected
        document.getElementById("turnOnBtn").disabled = false;
        document.getElementById("turnOffBtn").disabled = false;

        console.log('Connected to device', device);
      } catch (error) {
        console.error('Connection failed', error);
        updateStatus(`Failed to connect. Error: ${error.message}`);
      }
    });

    // Turn on light
    document.getElementById("turnOnBtn").addEventListener("click", async () => {
      try {
        updateStatus("Turning on light...");

        // Send command to turn the light on (1 for on)
        const onCommand = new Uint8Array([1]); // Example command to turn light on
        await lightCharacteristic.writeValue(onCommand);
        updateStatus("Light turned on.");
        console.log('Light turned on');
      } catch (error) {
        console.error('Error turning on light', error);
        updateStatus(`Error turning on the light. Message: ${error.message}`);
      }
    });

    // Turn off light
    document.getElementById("turnOffBtn").addEventListener("click", async () => {
      try {
        updateStatus("Turning off light...");

        // Send command to turn the light off (0 for off)
        const offCommand = new Uint8Array([0]); // Example command to turn light off
        await lightCharacteristic.writeValue(offCommand);
        updateStatus("Light turned off.");
        console.log('Light turned off');
      } catch (error) {
        console.error('Error turning off light', error);
        updateStatus(`Error turning off the light. Message: ${error.message}`);
      }
    });
  </script>
</body>
</html>
